<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube to MP3 Converter</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: #f0f2f5;
      color: #333;
    }
    .container {
      max-width: 600px;
      width: 100%;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 30px;
      text-align: center;
    }
    h1 {
      margin-top: 0;
      color: #1a73e8;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #1a73e8;
      width: 40px;
      height: 40px;
      margin: 20px auto;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      color: #d93025;
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #d93025;
      border-radius: 4px;
      background-color: #fce8e6;
    }
    .status {
      margin: 20px 0;
    }
    .manual-form {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
    }
    input, button {
      padding: 10px;
      margin: 5px;
    }
    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #1557b0;
    }
    .footer {
      margin-top: 30px;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>YouTube to MP3 Converter</h1>
    
    <div id="statusContainer" class="status">
      <p id="statusMessage">Processing your request...</p>
      <div id="spinner" class="spinner"></div>
    </div>
    
    <div id="errorContainer" class="error" style="display: none;">
      <p id="errorMessage"></p>
    </div>
    
    <div class="manual-form">
      <h3>Convert another YouTube video</h3>
      <p>Enter a YouTube video ID (e.g., dQw4w9WgXcQ) or full YouTube URL:</p>
      <input type="text" id="videoInput" placeholder="YouTube Video ID or URL">
      <button onclick="processManualInput()">Convert to MP3</button>
    </div>
    
    <div class="footer">
      <p>This service uses a local Cobalt API instance to convert YouTube videos to low-quality MP3 files.</p>
      <p>API running at: <span id="apiUrl">http://localhost:9000</span></p>
    </div>
  </div>

  <script>
    // Configuration
    const API_BASE_URL = 'http://localhost:9000';
    const API_KEY = '7c5a3e8d-94d0-4e8c-b6f2-1a9cd4ba5e87';
    
    // Elements
    const statusContainer = document.getElementById('statusContainer');
    const statusMessage = document.getElementById('statusMessage');
    const spinner = document.getElementById('spinner');
    const errorContainer = document.getElementById('errorContainer');
    const errorMessage = document.getElementById('errorMessage');
    const videoInput = document.getElementById('videoInput');
    
    // Extract YouTube video ID from URL
    function extractVideoId() {
      // First, check if it's from the path structure /api/{videoId}
      const pathParts = window.location.pathname.split('/');
      if (pathParts.length >= 3 && pathParts[1] === 'api') {
        return pathParts[2];
      }
      
      // If not in path, check if it's in query parameters
      const urlParams = new URLSearchParams(window.location.search);
      const videoId = urlParams.get('v');
      
      return videoId;
    }
    
    // Extract video ID from a YouTube URL
    function extractVideoIdFromUrl(url) {
      try {
        // Handle various YouTube URL formats
        if (url.includes('youtube.com/watch?v=')) {
          const urlObj = new URL(url);
          return urlObj.searchParams.get('v');
        } else if (url.includes('youtu.be/')) {
          return url.split('youtu.be/')[1].split('?')[0];
        } else if (url.match(/^[a-zA-Z0-9_-]{11}$/)) {
          // If it's already just the ID (11 characters)
          return url;
        }
      } catch (error) {
        console.error('Error extracting video ID:', error);
      }
      
      return null;
    }
    
    // Show error message
    function showError(message) {
      errorMessage.textContent = message;
      errorContainer.style.display = 'block';
      statusContainer.style.display = 'none';
    }
    
    // Process video conversion
    function processVideo(videoId) {
      if (!videoId) {
        showError('No YouTube video ID found in the URL. Please enter a video ID below.');
        statusContainer.style.display = 'none';
        return;
      }
      
      // Show loading state
      statusMessage.textContent = `Converting YouTube video ${videoId} to MP3...`;
      statusContainer.style.display = 'block';
      errorContainer.style.display = 'none';
      
      // Construct the YouTube URL
      const youtubeUrl = `https://www.youtube.com/watch?v=${videoId}`;
      
      // Construct the Cobalt API URL with parameters for low-quality MP3
      const apiUrl = `${API_BASE_URL}/api/json?url=${encodeURIComponent(youtubeUrl)}&audioFormat=mp3&audioBitrate=8&downloadMode=audio&disableMetadata=true`;
      
      // Redirect to the Cobalt API with the API key in the header
      try {
        // First try the fetch approach to handle errors better
        fetch(apiUrl, {
          headers: {
            'X-API-Key': API_KEY
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`API error: ${response.status} ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          // If successful, redirect to the download URL
          if (data.url) {
            window.location.href = data.url;
          } else {
            showError('No download URL returned from the API.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showError(`Failed to convert video: ${error.message}`);
          
          // As a fallback, try direct redirection
          statusMessage.textContent = 'Trying alternative method...';
          window.location.href = `${apiUrl}&apiKey=${API_KEY}`;
        });
      } catch (error) {
        console.error('Critical error:', error);
        showError(`Critical error: ${error.message}`);
      }
    }
    
    // Process manual input from the form
    function processManualInput() {
      const input = videoInput.value.trim();
      if (!input) {
        showError('Please enter a YouTube video ID or URL.');
        return;
      }
      
      const videoId = extractVideoIdFromUrl(input);
      if (!videoId) {
        showError('Invalid YouTube video ID or URL. Please check your input.');
        return;
      }
      
      // Update URL to reflect the video ID for bookmarking
      const newUrl = `${window.location.origin}/api/${videoId}`;
      window.history.pushState({}, '', newUrl);
      
      processVideo(videoId);
    }
    
    // Main execution - run when page loads
    document.addEventListener('DOMContentLoaded', function() {
      const videoId = extractVideoId();
      if (videoId) {
        processVideo(videoId);
      } else {
        statusContainer.style.display = 'none';
      }
    });
  </script>
</body>
</html>

